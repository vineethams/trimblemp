
<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <link rel="icon" href="https://components.connect.trimble.com/trimble-connect-project-workspace-api/favicon.ico"/>
        <meta name="viewport" content="width=device-width,initial-scale=1"/>
        <meta name="theme-color" content="#000000"/>
        <meta name="description" content="Web site created using create-react-app"/>
        <link rel="apple-touch-icon" href="https://components.connect.trimble.com/trimble-connect-project-workspace-api/logo192.png"/>
        <link rel="manifest" href="https://vineethams.github.io/trimblemp/extension-manifest.json"/>
        <title>Export to excel</title>
        <link href="https://components.connect.trimble.com/trimble-connect-project-workspace-api/static/css/2.46f1d6ec.chunk.css" rel="stylesheet">
        <link href="https://components.connect.trimble.com/trimble-connect-project-workspace-api/static/css/main.a2c16014.chunk.css" rel="stylesheet">
    </head>
    <body>
        <p>hello</p>
        <form action="" method="POST">
        <label for="url">Trimble Connect Folder URL:</label><br>
        <input type="text" id="url" name="url" required><br><br>

        <label for="region">Project Region (e.g., eu, na, au, as):</label><br>
        <input type="text" id="region" name="region" required><br><br>

        <label for="token">Bearer Token:</label><br>
        <input type="text" id="token" name="token" required><br><br>

        <button type="submit">Generate Excel</button>
    </form>
        <noscript>You need to enable JavaScript to run this app.</noscript>
        <div id="root"></div>

        <?php
            require 'vendor/autoload.php';

            use PhpOffice\PhpSpreadsheet\Spreadsheet;
            use PhpOffice\PhpSpreadsheet\Writer\Xlsx;
            use PhpOffice\PhpSpreadsheet\Style\Font;

            if ($_SERVER['REQUEST_METHOD'] === 'POST') {
                // Function to retrieve folder contents and extract PDF links
                function getPdfLinks($folderUrl, $bearerToken)
                {
                    $headers = [
                        "Authorization: Bearer $bearerToken"
                    ];

                    $ch = curl_init();
                    curl_setopt($ch, CURLOPT_URL, $folderUrl);
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
                    $response = curl_exec($ch);
                    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                    curl_close($ch);

                    if ($httpCode === 200) {
                        $folderContents = json_decode($response, true);
                        $pdfFiles = [];

                        // Handle response based on type
                        $items = $folderContents['items'] ?? $folderContents;

                        // Process the items to extract PDFs
                        foreach ($items as $item) {
                            if (isset($item['type']) && $item['type'] === 'FILE' && str_ends_with(strtolower($item['name']), '.pdf')) {
                                $pdfFiles[] = [
                                    'name' => $item['name'],
                                    'url' => $item['id'] ?? 'No URL Available'
                                ];
                            }
                        }
                        return $pdfFiles;
                    } else {
                        echo "Failed to retrieve folder contents. Status code: $httpCode\n";
                        echo $response;
                        return [];
                    }
                }

                // Function to create an Excel file with PDF names and URLs
                function createExcelWithLinks($pdfFiles, $urlInput, $outputFilename = "TrimblePdf_links.xlsx")
                {
                    $spreadsheet = new Spreadsheet();
                    $sheet = $spreadsheet->getActiveSheet();
                    $sheet->setTitle("PDF Links");

                    // Add headers
                    $sheet->setCellValue('A1', 'File Name');
                    $sheet->setCellValue('B1', 'Link');
                    $sheet->getStyle('A1:B1')->getFont()->setBold(true);

                    // Extract project ID
                    $urlParts = parse_url($urlInput);
                    $pathParts = explode('/', $urlParts['path']);
                    $projectId = $pathParts[array_search('projects', $pathParts) + 1];

                    // Insert PDF names and URLs
                    $rowIndex = 2;
                    foreach ($pdfFiles as $pdf) {
                        $pdfName = str_ends_with(strtolower($pdf['name']), '.pdf') ? substr($pdf['name'], 0, -4) : $pdf['name'];
                        $sheet->setCellValue("A$rowIndex", $pdfName);

                        $link = "https://web.connect.trimble.com/projects/$projectId/viewer/2D?id=" . $pdf['url'];
                        $sheet->setCellValue("B$rowIndex", '=HYPERLINK("' . $link . '", "' . $pdfName . '")');

                        // Apply hyperlink styling
                        $sheet->getStyle("B$rowIndex")->getFont()->getColor()->setARGB('FF0000FF');
                        $sheet->getStyle("B$rowIndex")->getFont()->setUnderline(Font::UNDERLINE_SINGLE);

                        $rowIndex++;
                    }

                    // Adjust column width
                    $sheet->getColumnDimension('A')->setWidth(40);
                    $sheet->getColumnDimension('B')->setWidth(30);

                    // Save the spreadsheet
                    $writer = new Xlsx($spreadsheet);
                    $writer->save($outputFilename);
                    echo "Spreadsheet created: $outputFilename\n";
                }

                // Collect form input
                $urlInput = $_POST['url'];
                $regionInput = $_POST['region'];
                $bearerToken = $_POST['token'];

                $parsedUrl = parse_url($urlInput);
                $pathParts = explode('/', $parsedUrl['path']);
                $folderId = end($pathParts);

                switch ($regionInput) {
                    case 'na':
                        $folderUrl = "https://app.connect.trimble.com/tc/api/2.0/folders/$folderId/items";
                        break;
                    case 'au':
                        $folderUrl = "https://app32.connect.trimble.com/tc/api/2.0/folders/$folderId/items";
                        break;
                    case 'as':
                        $folderUrl = "https://app31.connect.trimble.com/tc/api/2.0/folders/$folderId/items";
                        break;
                    case 'eu':
                        $folderUrl = "https://app21.connect.trimble.com/tc/api/2.0/folders/$folderId/items";
                        break;
                    default:
                        echo "Invalid region input.\n";
                        exit;
                }

                // Get PDF links and create Excel file
                $pdfFiles = getPdfLinks($folderUrl, $bearerToken);

                if (!empty($pdfFiles)) {
                    createExcelWithLinks($pdfFiles, $urlInput);
                }
            }
            ?>

        <script>
           
            !function(e) {
                function t(t) {
                    for (var n, a, i = t[0], c = t[1], l = t[2], s = 0, f = []; s < i.length; s++)
                        a = i[s],
                        Object.prototype.hasOwnProperty.call(o, a) && o[a] && f.push(o[a][0]),
                        o[a] = 0;
                    for (n in c)
                        Object.prototype.hasOwnProperty.call(c, n) && (e[n] = c[n]);
                    for (p && p(t); f.length; )
                        f.shift()()
                    return u.push.apply(u, l || []),
                    r()
                }
                function r() {
                    for (var e, t = 0; t < u.length; t++) {
                        for (var r = u[t], n = !0, i = 1; i < r.length; i++) {
                            var c = r[i];
                            0 !== o[c] && (n = !1)
                        }
                        n && (u.splice(t--, 1),
                        e = a(a.s = r[0]))
                    }
                    return e
                }
                var n = {}
                  , o = {
                    1: 0
                }
                  , u = [];
                function a(t) {
                    if (n[t])
                        return n[t].exports;
                    var r = n[t] = {
                        i: t,
                        l: !1,
                        exports: {}
                    };
                    return e[t].call(r.exports, r, r.exports, a),
                    r.l = !0,
                    r.exports
                }
                a.e = function(e) {
                    var t = []
                      , r = o[e];
                    if (0 !== r)
                        if (r)
                            t.push(r[2]);
                        else {
                            var n = new Promise((function(t, n) {
                                r = o[e] = [t, n]
                            }
                            ));
                            t.push(r[2] = n);
                            var u, i = document.createElement("script");
                            i.charset = "utf-8",
                            i.timeout = 120,
                            a.nc && i.setAttribute("nonce", a.nc),
                            i.src = function(e) {
                                return a.p + "static/js/" + ({}[e] || e) + "." + {
                                    3: "15105964"
                                }[e] + ".chunk.js"
                            }(e);
                            var c = new Error;
                            u = function(t) {
                                i.onerror = i.onload = null,
                                clearTimeout(l);
                                var r = o[e];
                                if (0 !== r) {
                                    if (r) {
                                        var n = t && ("load" === t.type ? "missing" : t.type)
                                          , u = t && t.target && t.target.src;
                                        c.message = "Loading chunk " + e + " failed.\n(" + n + ": " + u + ")",
                                        c.name = "ChunkLoadError",
                                        c.type = n,
                                        c.request = u,
                                        r[1](c)
                                    }
                                    o[e] = void 0
                                }
                            }
                            ;
                            var l = setTimeout((function() {
                                u({
                                    type: "timeout",
                                    target: i
                                })
                            }
                            ), 12e4);
                            i.onerror = i.onload = u,
                            document.head.appendChild(i)
                        }
                    return Promise.all(t)
                }
                ,
                a.m = e,
                a.c = n,
                a.d = function(e, t, r) {
                    a.o(e, t) || Object.defineProperty(e, t, {
                        enumerable: !0,
                        get: r
                    })
                }
                ,
                a.r = function(e) {
                    "undefined" != typeof Symbol && Symbol.toStringTag && Object.defineProperty(e, Symbol.toStringTag, {
                        value: "Module"
                    }),
                    Object.defineProperty(e, "__esModule", {
                        value: !0
                    })
                }
                ,
                a.t = function(e, t) {
                    if (1 & t && (e = a(e)),
                    8 & t)
                        return e;
                    if (4 & t && "object" == typeof e && e && e.__esModule)
                        return e;
                    var r = Object.create(null);
                    if (a.r(r),
                    Object.defineProperty(r, "default", {
                        enumerable: !0,
                        value: e
                    }),
                    2 & t && "string" != typeof e)
                        for (var n in e)
                            a.d(r, n, function(t) {
                                return e[t]
                            }
                            .bind(null, n));
                    return r
                }
                ,
                a.n = function(e) {
                    var t = e && e.__esModule ? function() {
                        return e.default
                    }
                    : function() {
                        return e
                    }
                    ;
                    return a.d(t, "a", t),
                    t
                }
                ,
                a.o = function(e, t) {
                    return Object.prototype.hasOwnProperty.call(e, t)
                }
                ,
                a.p = "/trimble-connect-project-workspace-api/",
                a.oe = function(e) {
                    throw console.error(e),
                    e
                }
                ;
                var i = this["webpackJsonpmy-test-app"] = this["webpackJsonpmy-test-app"] || []
                  , c = i.push.bind(i);
                i.push = t,
                i = i.slice();
                for (var l = 0; l < i.length; l++)
                    t(i[l]);
                var p = c;
                r()
            }([])
        </script>
        <script src="https://components.connect.trimble.com/trimble-connect-project-workspace-api/static/js/2.209796c4.chunk.js"></script>
        <script src="https://vineethams.github.io/trimblemp/nktrimble.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    </body>
</html>
