<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <link rel="icon" href="https://components.connect.trimble.com/trimble-connect-project-workspace-api/favicon.ico"/>
        <meta name="viewport" content="width=device-width,initial-scale=1"/>
        <meta name="theme-color" content="#000000"/>
        <meta name="description" content="Web site created using create-react-app"/>
        <link rel="apple-touch-icon" href="https://components.connect.trimble.com/trimble-connect-project-workspace-api/logo192.png"/>
        <link rel="manifest" href="https://vineethams.github.io/trimblemp/extension-manifest.json"/>
        <title>Export to excel</title>
        <link href="https://components.connect.trimble.com/trimble-connect-project-workspace-api/static/css/2.46f1d6ec.chunk.css" rel="stylesheet">
        <link href="https://components.connect.trimble.com/trimble-connect-project-workspace-api/static/css/main.a2c16014.chunk.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    </head>
    <body>
        <p>hello</p>
         <form id="form">
            <label style="margin-left:20px;" for="folderUrl">Trimble Connect Folder URL:</label>
            <input style="margin-left:20px;width:500px;" type="url" id="folderUrl" placeholder="Enter folder URL" required>
            <br><br>
    
            <label style="margin-left:20px;" for="region">Region:</label>
            <select style="margin-left:20px;" id="region" required>
                <option value="na">North America</option>
                <option value="au">Australia</option>
                <option value="as">Asia</option>
                <option value="eu">Europe</option>
            </select>
            <br><br>
    
            <button style="margin-left:20px;" type="submit">Generate Excel</button>
    </form>

    <p id="status"></p>
        
        <noscript>You need to enable JavaScript to run this app.</noscript>
        <div id="root"></div>


        <script>

                var G = function(e) {
                    Object(b.a)(n, e);
                    var t = Object(x.a)(n);
                    function n(e) {
                        var s;
                        return Object(u.a)(this, n),
                        (s = t.call(this, e)).setActiveCommand = function(e, t) {
                            e.preventDefault(),
                            e.stopPropagation(),
                            s.setState({
                                activeCommand: t
                            });
                        },
                        s.getAccessToken = function() {
                            s.API && s.API.extension.getPermission("accesstoken").then((function(e) {
                                return s.setState({
                                    accessToken: e
                                });
                            }));
                        },
                        s.handleUserUrlChange = function(e) {
                            s.setState({
                                userurl: e.target.value
                            });
                        },
                        s.state = {
                            mainMenu: {
                                title: "Export to Excel",
                                icon: "https://components.stage.connect.trimble.com/trimble-connect-project-workspace-api/logo192.png",
                                command: "main_nav_menu_cliked"
                            },
                            subMenuItems: [{
                                title: "Export",
                                icon: "https://components.stage.connect.trimble.com/trimble-connect-project-workspace-api/logo192.png",
                                command: "submenu_1_clicked"
                            }],
                            queryParams: "?taskId=16&navigate=true",
                            editParams: !1,
                            userurl: "", // Add state for userurl
                        },
                        s;
                    }
                    return Object(h.a)(n, [{
                        key: "render",
                        value: function() {
                            var e = this,
                                t = this.state,
                                n = t.mainMenu,
                                s = t.subMenuItems,
                                c = void 0 === s ? [] : s,
                                a = t.activeCommand,
                                i = t.modal,
                                r = void 0 !== i && i,
                                o = t.formData,
                                m = void 0 === o ? {} : o,
                                l = t.alertMessage,
                                j = t.statusMessage,
                                d = void 0 === j ? "" : j,
                                u = t.projectInfo,
                                h = void 0 === u ? {} : u,
                                b = t.userSettings,
                                x = void 0 === b ? {} : b,
                                N = t.accessToken,
                                z = void 0 === N ? "" : N,
                                userurl = t.userurl; // Access userurl from state
                
                            return Object(U.jsxs)(p.a, {
                                className: "section",
                                children: [
                                    Object(U.jsxs)(g.a, {
                                        md: "12",
                                        children: [
                                            Object(U.jsxs)("h3", {
                                                children: ["Example: ", Object(U.jsx)("i", {
                                                    children: "extension.getPermission"
                                                })]
                                            }),
                                            Object(U.jsxs)("p", {
                                                children: ["Request the accessToken.", " ", Object(U.jsx)(v.a, {
                                                    color: "primary",
                                                    size: "sm",
                                                    style: {
                                                        marginLeft: "2rem"
                                                    },
                                                    onClick: this.getAccessToken,
                                                    children: "Get accessToken"
                                                })]
                                            })
                                        ]
                                    }),
                                    Object(U.jsx)(g.a, {
                                        md: "12",
                                        children: Object(U.jsx)(I.a, {
                                            children: Object(U.jsxs)(P.a, {
                                                row: !0,
                                                style: {
                                                    marginBottom: "1rem"
                                                },
                                                children: [
                                                    Object(U.jsx)(A.a, {
                                                        for: "userurl",
                                                        sm: 2,
                                                        className: "capz",
                                                        children: "User URL"
                                                    }),
                                                    Object(U.jsx)(g.a, {
                                                        sm: 10,
                                                        children: Object(U.jsx)(S.a, {
                                                            type: "text",
                                                            name: "userurl",
                                                            id: "userurl",
                                                            value: userurl,
                                                            onChange: this.handleUserUrlChange, // Update state on change
                                                            placeholder: "Enter your URL"
                                                        })
                                                    })
                                                ]
                                            })
                                        })
                                    }),
                                    Object(U.jsx)(g.a, {
                                        md: "12",
                                        children: Object(U.jsx)(I.a, {
                                            children: Object(U.jsxs)(P.a, {
                                                row: !0,
                                                style: {
                                                    marginBottom: "1rem"
                                                },
                                                children: [
                                                    Object(U.jsx)(A.a, {
                                                        for: "accessToken",
                                                        sm: 2,
                                                        className: "capz",
                                                        children: "AccessToken"
                                                    }),
                                                    Object(U.jsx)(g.a, {
                                                        sm: 10,
                                                        children: Object(U.jsx)(S.a, {
                                                            type: "text",
                                                            name: "accessToken",
                                                            id: "accessToken",
                                                            value: z,
                                                            readOnly: !0
                                                        })
                                                    })
                                                ]
                                            })
                                        })
                                    })
                                ]
                            });
                        }
                    }]), n;
                }(c.a.Component);

                document.getElementById("form").addEventListener("submit", async function (e) {
                    e.preventDefault();

                    const folderUrl = document.getElementById("folderUrl").value;
                    const region = document.getElementById("region").value;

                    document.getElementById("status").innerText = "Fetching PDF links...";

                    try {
                        // Fetch AccessToken
                        const accessToken = await extension.getPermission("accesstoken");
                        if (!accessToken) {
                            throw new Error("Failed to retrieve access token.");
                        }

                        // Parse folder ID
                        const urlParts = new URL(folderUrl);
                        const pathParts = urlParts.pathname.split("/");
                        const folderId = pathParts[pathParts.length - 1];

                        // Determine API URL
                        const baseUrl = {
                            na: "https://app.connect.trimble.com/tc/api/2.0/folders/",
                            au: "https://app32.connect.trimble.com/tc/api/2.0/folders/",
                            as: "https://app31.connect.trimble.com/tc/api/2.0/folders/",
                            eu: "https://app21.connect.trimble.com/tc/api/2.0/folders/"
                        }[region];

                        const apiUrl = `${baseUrl}${folderId}/items`;

                        // Fetch folder contents
                        const response = await axios.get(apiUrl, {
                            headers: {
                                Authorization: `Bearer ${accessToken}`
                            }
                        });

                        const pdfFiles = [];
                        const items = response.data.items || response.data;

                        items.forEach(item => {
                            if (item.type === "FILE" && item.name.toLowerCase().endsWith(".pdf")) {
                                pdfFiles.push({
                                    name: item.name,
                                    url: item.id
                                });
                            }
                        });

                        if (pdfFiles.length === 0) {
                            document.getElementById("status").innerText = "No PDF files found.";
                            return;
                        }

                        // Generate Excel
                        const workbook = XLSX.utils.book_new();
                        workbook.Props = { Title: "Trimble PDF Links" };

                        const sheetData = [["File Name", "Link"]];
                        const projectId = pathParts[pathParts.indexOf("projects") + 1];

                        pdfFiles.forEach(pdf => {
                            const link = `https://web.connect.trimble.com/projects/${projectId}/viewer/2D?id=${pdf.url}`;
                            sheetData.push([pdf.name, link]);
                        });

                        const worksheet = XLSX.utils.aoa_to_sheet(sheetData);
                        XLSX.utils.book_append_sheet(workbook, worksheet, "PDF Links");

                        const excelBuffer = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
                        const blob = new Blob([excelBuffer], { type: "application/octet-stream" });
                        const link = document.createElement("a");
                        link.href = URL.createObjectURL(blob);
                        link.download = "TrimblePdf_links.xlsx";
                        link.click();

                        document.getElementById("status").innerText = "Excel file generated successfully.";
                    } catch (error) {
                        console.error("Error fetching or processing data:", error);
                        document.getElementById("status").innerText = "Failed to retrieve or process data.";
                }
            });

                   
                !function(e) {
                    function t(t) {
                        for (var n, a, i = t[0], c = t[1], l = t[2], s = 0, f = []; s < i.length; s++)
                            a = i[s],
                            Object.prototype.hasOwnProperty.call(o, a) && o[a] && f.push(o[a][0]),
                            o[a] = 0;
                        for (n in c)
                            Object.prototype.hasOwnProperty.call(c, n) && (e[n] = c[n]);
                        for (p && p(t); f.length; )
                            f.shift()()
                        return u.push.apply(u, l || []),
                        r()
                    }
                    function r() {
                        for (var e, t = 0; t < u.length; t++) {
                            for (var r = u[t], n = !0, i = 1; i < r.length; i++) {
                                var c = r[i];
                                0 !== o[c] && (n = !1)
                            }
                            n && (u.splice(t--, 1),
                            e = a(a.s = r[0]))
                        }
                        return e
                    }
                    var n = {}
                    , o = {
                        1: 0
                    }
                    , u = [];
                    function a(t) {
                        if (n[t])
                            return n[t].exports;
                        var r = n[t] = {
                            i: t,
                            l: !1,
                            exports: {}
                        };
                        return e[t].call(r.exports, r, r.exports, a),
                        r.l = !0,
                        r.exports
                    }
                    a.e = function(e) {
                        var t = []
                        , r = o[e];
                        if (0 !== r)
                            if (r)
                                t.push(r[2]);
                            else {
                                var n = new Promise((function(t, n) {
                                    r = o[e] = [t, n]
                                }
                                ));
                                t.push(r[2] = n);
                                var u, i = document.createElement("script");
                                i.charset = "utf-8",
                                i.timeout = 120,
                                a.nc && i.setAttribute("nonce", a.nc),
                                i.src = function(e) {
                                    return a.p + "static/js/" + ({}[e] || e) + "." + {
                                        3: "15105964"
                                    }[e] + ".chunk.js"
                                }(e);
                                var c = new Error;
                                u = function(t) {
                                    i.onerror = i.onload = null,
                                    clearTimeout(l);
                                    var r = o[e];
                                    if (0 !== r) {
                                        if (r) {
                                            var n = t && ("load" === t.type ? "missing" : t.type)
                                            , u = t && t.target && t.target.src;
                                            c.message = "Loading chunk " + e + " failed.\n(" + n + ": " + u + ")",
                                            c.name = "ChunkLoadError",
                                            c.type = n,
                                            c.request = u,
                                            r[1](c)
                                        }
                                        o[e] = void 0
                                    }
                                }
                                ;
                                var l = setTimeout((function() {
                                    u({
                                        type: "timeout",
                                        target: i
                                    })
                                }
                                ), 12e4);
                                i.onerror = i.onload = u,
                                document.head.appendChild(i)
                            }
                        return Promise.all(t)
                    }
                    ,
                    a.m = e,
                    a.c = n,
                    a.d = function(e, t, r) {
                        a.o(e, t) || Object.defineProperty(e, t, {
                            enumerable: !0,
                            get: r
                        })
                    }
                    ,
                    a.r = function(e) {
                        "undefined" != typeof Symbol && Symbol.toStringTag && Object.defineProperty(e, Symbol.toStringTag, {
                            value: "Module"
                        }),
                        Object.defineProperty(e, "__esModule", {
                            value: !0
                        })
                    }
                    ,
                    a.t = function(e, t) {
                        if (1 & t && (e = a(e)),
                        8 & t)
                            return e;
                        if (4 & t && "object" == typeof e && e && e.__esModule)
                            return e;
                        var r = Object.create(null);
                        if (a.r(r),
                        Object.defineProperty(r, "default", {
                            enumerable: !0,
                            value: e
                        }),
                        2 & t && "string" != typeof e)
                            for (var n in e)
                                a.d(r, n, function(t) {
                                    return e[t]
                                }
                                .bind(null, n));
                        return r
                    }
                    ,
                    a.n = function(e) {
                        var t = e && e.__esModule ? function() {
                            return e.default
                        }
                        : function() {
                            return e
                        }
                        ;
                        return a.d(t, "a", t),
                        t
                    }
                    ,
                    a.o = function(e, t) {
                        return Object.prototype.hasOwnProperty.call(e, t)
                    }
                    ,
                    a.p = "/trimble-connect-project-workspace-api/",
                    a.oe = function(e) {
                        throw console.error(e),
                        e
                    }
                    ;
                    var i = this["webpackJsonpmy-test-app"] = this["webpackJsonpmy-test-app"] || []
                    , c = i.push.bind(i);
                    i.push = t,
                    i = i.slice();
                    for (var l = 0; l < i.length; l++)
                        t(i[l]);
                    var p = c;
                    r()

                    
            
                }([])
        </script>
        <script src="https://components.connect.trimble.com/trimble-connect-project-workspace-api/static/js/2.209796c4.chunk.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    </body>
</html>
